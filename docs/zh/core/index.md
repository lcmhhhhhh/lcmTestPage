# VeCLI 核心

VeCLI 的核心包 (`packages/core`) 是 VeCLI 的后端部分，负责与火山引擎 API 通信、管理工具以及处理从 `packages/cli` 发送的请求。有关 VeCLI 的一般概述，请参阅 [主文档页面](../index.md)。

## 导航此部分

- **[核心工具 API](./tools-api.md):** 有关核心如何定义、注册和使用工具的信息。
- **[内存导入处理器](./memport.md):** 使用 @file.md 语法的模块化 VE.md 导入功能的文档。

## 核心的作用

虽然 VeCLI 的 `packages/cli` 部分提供了用户界面，但 `packages/core` 负责：

- **火山引擎 API 交互:** 安全地与火山引擎 API 通信，发送用户提示并接收模型响应。
- **提示工程:** 为火山引擎模型构建有效的提示，可能包含对话历史、工具定义以及来自 `VE.md` 文件的指令上下文。
- **工具管理与编排:**
  - 注册可用工具（例如，文件系统工具、shell 命令执行）。
  - 解释来自火山引擎模型的工具使用请求。
  - 使用提供的参数执行请求的工具。
  - 将工具执行结果返回给火山引擎模型以进行进一步处理。
- **会话和状态管理:** 跟踪对话状态，包括历史记录和进行连贯交互所需的任何相关上下文。
- **配置:** 管理核心特定的配置，例如 API 密钥访问、模型选择和工具设置。

## 安全注意事项

核心在安全方面发挥着至关重要的作用：

- **API 密钥管理:** 它处理 `VOLCENGINE_API_KEY` 并确保在与火山引擎 API 通信时安全地使用它。
- **工具执行:** 当工具与本地系统交互时（例如，`run_shell_command`），核心（及其底层工具实现）必须以适当的谨慎进行操作，通常涉及沙盒机制以防止意外修改。

## 聊天历史压缩

为了确保长对话不会超过火山引擎模型的令牌限制，核心包含了一个聊天历史压缩功能。

当对话接近配置模型的令牌限制时，核心会在将对话历史发送到模型之前自动压缩它。这种压缩在传达的信息方面被设计为无损的，但它减少了使用的令牌总数。

您可以在 [火山引擎方舟平台](https://console.volcengine.com/ark/) 中找到每个模型的令牌限制。

## 模型回退

VeCLI 包含一个模型回退机制，以确保即使默认的 "pro" 模型受到速率限制，您也可以继续使用 CLI。

如果您使用的是默认的 "pro" 模型，并且 CLI 检测到您受到速率限制，它会自动在当前会话中切换到 "flash" 模型。这使您能够继续工作而不会中断。

## 文件发现服务

文件发现服务负责在项目中查找与当前上下文相关的文件。它由 `@` 命令和其他需要访问文件的工具使用。

## 内存发现服务

内存发现服务负责查找和加载提供模型上下文的 `VE.md` 文件。它以分层方式搜索这些文件，从当前工作目录开始，向上移动到项目根目录和用户的主目录。它还会在子目录中搜索。

这允许您拥有全局、项目级别和组件级别的上下文文件，所有这些文件都组合在一起，为模型提供最相关的信息。

您可以使用 [`/memory` 命令](../cli/commands.md) 来 `show`、`add` 和 `refresh` 已加载的 `VE.md` 文件的内容。