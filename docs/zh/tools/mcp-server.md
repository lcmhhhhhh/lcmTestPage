# ä½¿ç”¨ VeCLI çš„ MCP æœåŠ¡å™¨

æœ¬æ–‡æ¡£æä¾›äº†åœ¨ VeCLI ä¸­é…ç½®å’Œä½¿ç”¨æ¨¡å‹ä¸Šä¸‹æ–‡åè®® (MCP) æœåŠ¡å™¨çš„æŒ‡å—ã€‚

## ä»€ä¹ˆæ˜¯ MCP æœåŠ¡å™¨ï¼Ÿ

MCP æœåŠ¡å™¨æ˜¯ä¸€ä¸ªé€šè¿‡æ¨¡å‹ä¸Šä¸‹æ–‡åè®®å‘ VeCLI å…¬å¼€å·¥å…·å’Œèµ„æºçš„åº”ç”¨ç¨‹åºï¼Œä½¿å…¶èƒ½å¤Ÿä¸å¤–éƒ¨ç³»ç»Ÿå’Œæ•°æ®æºäº¤äº’ã€‚MCP æœåŠ¡å™¨å……å½“ Vecli æ¨¡å‹ä¸æ‚¨çš„æœ¬åœ°ç¯å¢ƒæˆ–å…¶ä»–æœåŠ¡ï¼ˆå¦‚ APIï¼‰ä¹‹é—´çš„æ¡¥æ¢ã€‚

MCP æœåŠ¡å™¨ä½¿ VeCLI èƒ½å¤Ÿï¼š

- **å‘ç°å·¥å…·ï¼š** é€šè¿‡æ ‡å‡†åŒ–çš„æ¨¡å¼å®šä¹‰åˆ—å‡ºå¯ç”¨çš„å·¥å…·ã€å…¶æè¿°å’Œå‚æ•°ã€‚
- **æ‰§è¡Œå·¥å…·ï¼š** ä½¿ç”¨å®šä¹‰çš„å‚æ•°è°ƒç”¨ç‰¹å®šå·¥å…·å¹¶æ¥æ”¶ç»“æ„åŒ–å“åº”ã€‚
- **è®¿é—®èµ„æºï¼š** ä»ç‰¹å®šèµ„æºè¯»å–æ•°æ®ï¼ˆå°½ç®¡ VeCLI ä¸»è¦ä¸“æ³¨äºå·¥å…·æ‰§è¡Œï¼‰ã€‚

é€šè¿‡ MCP æœåŠ¡å™¨ï¼Œæ‚¨å¯ä»¥æ‰©å±• VeCLI çš„åŠŸèƒ½ï¼Œä½¿å…¶èƒ½å¤Ÿæ‰§è¡Œè¶…å‡ºå…¶å†…ç½®åŠŸèƒ½çš„æ“ä½œï¼Œä¾‹å¦‚ä¸æ•°æ®åº“ã€APIã€è‡ªå®šä¹‰è„šæœ¬æˆ–ä¸“ç”¨å·¥ä½œæµäº¤äº’ã€‚

## æ ¸å¿ƒé›†æˆæ¶æ„

VeCLI é€šè¿‡å†…ç½®åœ¨æ ¸å¿ƒåŒ… (`packages/core/src/tools/`) ä¸­çš„å¤æ‚å‘ç°å’Œæ‰§è¡Œç³»ç»Ÿä¸ MCP æœåŠ¡å™¨é›†æˆï¼š

### å‘ç°é˜¶æ®µ (`mcp-client.ts`)

å‘ç°è¿‡ç¨‹ç”± `discoverMcpTools()` ç¼–æ’ï¼Œè¯¥è¿‡ç¨‹ï¼š

1. **éå†é…ç½®çš„æœåŠ¡å™¨** ä»æ‚¨çš„ `settings.json` `mcpServers` é…ç½®ä¸­
2. **å»ºç«‹è¿æ¥** ä½¿ç”¨é€‚å½“çš„ä¼ è¾“æœºåˆ¶ï¼ˆStdioã€SSE æˆ–å¯æµå¼ HTTPï¼‰
3. **è·å–å·¥å…·å®šä¹‰** ä½¿ç”¨ MCP åè®®ä»æ¯ä¸ªæœåŠ¡å™¨è·å–
4. **æ¸…ç†å’ŒéªŒè¯** å·¥å…·æ¨¡å¼ä»¥ç¡®ä¿ä¸ Vecli API å…¼å®¹
5. **æ³¨å†Œå·¥å…·** åœ¨å…¨å±€å·¥å…·æ³¨å†Œè¡¨ä¸­ï¼Œå¹¶è§£å†³å†²çª

### æ‰§è¡Œå±‚ (`mcp-tool.ts`)

æ¯ä¸ªå‘ç°çš„ MCP å·¥å…·éƒ½åŒ…è£…åœ¨ `DiscoveredMCPTool` å®ä¾‹ä¸­ï¼Œè¯¥å®ä¾‹ï¼š

- **å¤„ç†ç¡®è®¤é€»è¾‘** åŸºäºæœåŠ¡å™¨ä¿¡ä»»è®¾ç½®å’Œç”¨æˆ·åå¥½
- **ç®¡ç†å·¥å…·æ‰§è¡Œ** é€šè¿‡ä½¿ç”¨æ­£ç¡®çš„å‚æ•°è°ƒç”¨ MCP æœåŠ¡å™¨
- **å¤„ç†å“åº”** ç”¨äº LLM ä¸Šä¸‹æ–‡å’Œç”¨æˆ·æ˜¾ç¤º
- **ç»´æŠ¤è¿æ¥çŠ¶æ€** å¹¶å¤„ç†è¶…æ—¶

### ä¼ è¾“æœºåˆ¶

VeCLI æ”¯æŒä¸‰ç§ MCP ä¼ è¾“ç±»å‹ï¼š

- **Stdio ä¼ è¾“ï¼š** ç”Ÿæˆå­è¿›ç¨‹å¹¶é€šè¿‡ stdin/stdout é€šä¿¡
- **SSE ä¼ è¾“ï¼š** è¿æ¥åˆ°æœåŠ¡å™¨å‘é€äº‹ä»¶ç«¯ç‚¹
- **å¯æµå¼ HTTP ä¼ è¾“ï¼š** ä½¿ç”¨ HTTP æµè¿›è¡Œé€šä¿¡

## å¦‚ä½•è®¾ç½®æ‚¨çš„ MCP æœåŠ¡å™¨

VeCLI ä½¿ç”¨ `settings.json` æ–‡ä»¶ä¸­çš„ `mcpServers` é…ç½®æ¥å®šä½å’Œè¿æ¥åˆ° MCP æœåŠ¡å™¨ã€‚æ­¤é…ç½®æ”¯æŒå…·æœ‰ä¸åŒä¼ è¾“æœºåˆ¶çš„å¤šä¸ªæœåŠ¡å™¨ã€‚

### åœ¨ settings.json ä¸­é…ç½® MCP æœåŠ¡å™¨

æ‚¨å¯ä»¥åœ¨ `settings.json` æ–‡ä»¶ä¸­ä»¥ä¸¤ç§ä¸»è¦æ–¹å¼é…ç½® MCP æœåŠ¡å™¨ï¼šé€šè¿‡é¡¶å±‚ `mcpServers` å¯¹è±¡è¿›è¡Œç‰¹å®šæœåŠ¡å™¨å®šä¹‰ï¼Œä»¥åŠé€šè¿‡ `mcp` å¯¹è±¡è¿›è¡Œæ§åˆ¶æœåŠ¡å™¨å‘ç°å’Œæ‰§è¡Œçš„å…¨å±€è®¾ç½®ã€‚

#### å…¨å±€ MCP è®¾ç½® (`mcp`)

`settings.json` ä¸­çš„ `mcp` å¯¹è±¡å…è®¸æ‚¨ä¸ºæ‰€æœ‰ MCP æœåŠ¡å™¨å®šä¹‰å…¨å±€è§„åˆ™ã€‚

- **`mcp.serverCommand`** (å­—ç¬¦ä¸²): å¯åŠ¨ MCP æœåŠ¡å™¨çš„å…¨å±€å‘½ä»¤ã€‚
- **`mcp.allowed`** (å­—ç¬¦ä¸²æ•°ç»„): è¦å…è®¸çš„ MCP æœåŠ¡å™¨åç§°åˆ—è¡¨ã€‚å¦‚æœè®¾ç½®äº†æ­¤é¡¹ï¼Œåˆ™åªä¼šè¿æ¥åˆ°æ­¤åˆ—è¡¨ä¸­çš„æœåŠ¡å™¨ï¼ˆä¸ `mcpServers` å¯¹è±¡ä¸­çš„é”®åŒ¹é…ï¼‰ã€‚
- **`mcp.excluded`** (å­—ç¬¦ä¸²æ•°ç»„): è¦æ’é™¤çš„ MCP æœåŠ¡å™¨åç§°åˆ—è¡¨ã€‚æ­¤åˆ—è¡¨ä¸­çš„æœåŠ¡å™¨å°†ä¸ä¼šè¢«è¿æ¥ã€‚

**ç¤ºä¾‹ï¼š**

```json
{
  "mcp": {
    "allowed": ["my-trusted-server"],
    "excluded": ["experimental-server"]
  }
}
```

#### æœåŠ¡å™¨ç‰¹å®šé…ç½® (`mcpServers`)

`mcpServers` å¯¹è±¡æ˜¯æ‚¨å®šä¹‰å¸Œæœ› CLI è¿æ¥çš„æ¯ä¸ªå•ç‹¬ MCP æœåŠ¡å™¨çš„åœ°æ–¹ã€‚

### é…ç½®ç»“æ„

å°† `mcpServers` å¯¹è±¡æ·»åŠ åˆ°æ‚¨çš„ `settings.json` æ–‡ä»¶ä¸­ï¼š

```json
{ ...æ–‡ä»¶åŒ…å«å…¶ä»–é…ç½®å¯¹è±¡
  "mcpServers": {
    "serverName": {
      "command": "path/to/server",
      "args": ["--arg1", "value1"],
      "env": {
        "API_KEY": "$MY_API_TOKEN"
      },
      "cwd": "./server-directory",
      "timeout": 30000,
      "trust": false
    }
  }
}
```

### é…ç½®å±æ€§

æ¯ä¸ªæœåŠ¡å™¨é…ç½®æ”¯æŒä»¥ä¸‹å±æ€§ï¼š

#### å¿…éœ€ï¼ˆä»¥ä¸‹ä¹‹ä¸€ï¼‰

- **`command`** (å­—ç¬¦ä¸²): Stdio ä¼ è¾“çš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„
- **`url`** (å­—ç¬¦ä¸²): SSE ç«¯ç‚¹ URLï¼ˆä¾‹å¦‚ï¼Œ`"http://localhost:8080/sse"`ï¼‰
- **`httpUrl`** (å­—ç¬¦ä¸²): HTTP æµç«¯ç‚¹ URL

#### å¯é€‰

- **`args`** (å­—ç¬¦ä¸²[]): Stdio ä¼ è¾“çš„å‘½ä»¤è¡Œå‚æ•°
- **`headers`** (å¯¹è±¡): ä½¿ç”¨ `url` æˆ– `httpUrl` æ—¶çš„è‡ªå®šä¹‰ HTTP æ ‡å¤´
- **`env`** (å¯¹è±¡): æœåŠ¡å™¨è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ã€‚å€¼å¯ä»¥ä½¿ç”¨ `$VAR_NAME` æˆ– `${VAR_NAME}` è¯­æ³•å¼•ç”¨ç¯å¢ƒå˜é‡
- **`cwd`** (å­—ç¬¦ä¸²): Stdio ä¼ è¾“çš„å·¥ä½œç›®å½•
- **`timeout`** (æ•°å­—): è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼ˆé»˜è®¤å€¼ï¼š600,000ms = 10 åˆ†é’Ÿï¼‰
- **`trust`** (å¸ƒå°”å€¼): å½“ä¸º `true` æ—¶ï¼Œç»•è¿‡æ­¤æœåŠ¡å™¨çš„æ‰€æœ‰å·¥å…·è°ƒç”¨ç¡®è®¤ï¼ˆé»˜è®¤å€¼ï¼š`false`ï¼‰
- **`includeTools`** (å­—ç¬¦ä¸²[]): è¦ä»æ­¤ MCP æœåŠ¡å™¨åŒ…å«çš„å·¥å…·åç§°åˆ—è¡¨ã€‚æŒ‡å®šæ—¶ï¼Œä»…æ­¤å¤„åˆ—å‡ºçš„å·¥å…·å°†ä»æ­¤æœåŠ¡å™¨å¯ç”¨ï¼ˆå…è®¸åˆ—è¡¨è¡Œä¸ºï¼‰ã€‚å¦‚æœæœªæŒ‡å®šï¼Œåˆ™é»˜è®¤å¯ç”¨æœåŠ¡å™¨ä¸­çš„æ‰€æœ‰å·¥å…·ã€‚
- **`excludeTools`** (å­—ç¬¦ä¸²[]): è¦ä»æ­¤ MCP æœåŠ¡å™¨æ’é™¤çš„å·¥å…·åç§°åˆ—è¡¨ã€‚æ­¤å¤„åˆ—å‡ºçš„å·¥å…·å°†ä¸å¯ç”¨äºæ¨¡å‹ï¼Œå³ä½¿æœåŠ¡å™¨å…¬å¼€äº†å®ƒä»¬ã€‚**æ³¨æ„ï¼š** `excludeTools` ä¼˜å…ˆäº `includeTools` - å¦‚æœä¸€ä¸ªå·¥å…·åœ¨ä¸¤ä¸ªåˆ—è¡¨ä¸­ï¼Œåˆ™ä¼šè¢«æ’é™¤ã€‚

### è¿œç¨‹ MCP æœåŠ¡å™¨çš„ OAuth æ”¯æŒ

VeCLI æ”¯æŒä½¿ç”¨ SSE æˆ– HTTP ä¼ è¾“å¯¹éœ€è¦èº«ä»½éªŒè¯çš„è¿œç¨‹ MCP æœåŠ¡å™¨è¿›è¡Œ OAuth 2.0 èº«ä»½éªŒè¯ã€‚è¿™å¯ä»¥å®‰å…¨åœ°è®¿é—®éœ€è¦èº«ä»½éªŒè¯çš„ MCP æœåŠ¡å™¨ã€‚

#### è‡ªåŠ¨ OAuth å‘ç°

å¯¹äºæ”¯æŒ OAuth å‘ç°çš„æœåŠ¡å™¨ï¼Œæ‚¨å¯ä»¥çœç•¥ OAuth é…ç½®ï¼Œè®© CLI è‡ªåŠ¨å‘ç°å®ƒï¼š

```json
{
  "mcpServers": {
    "discoveredServer": {
      "url": "https://api.example.com/sse"
    }
  }
}
```

CLI å°†è‡ªåŠ¨ï¼š

- æ£€æµ‹æœåŠ¡å™¨ä½•æ—¶éœ€è¦ OAuth èº«ä»½éªŒè¯ï¼ˆ401 å“åº”ï¼‰
- ä»æœåŠ¡å™¨å…ƒæ•°æ®å‘ç° OAuth ç«¯ç‚¹
- å¦‚æœæ”¯æŒï¼Œæ‰§è¡ŒåŠ¨æ€å®¢æˆ·ç«¯æ³¨å†Œ
- å¤„ç† OAuth æµå’Œä»¤ç‰Œç®¡ç†

#### èº«ä»½éªŒè¯æµ

è¿æ¥åˆ°å¯ç”¨äº† OAuth çš„æœåŠ¡å™¨æ—¶ï¼š

1. **åˆå§‹è¿æ¥å°è¯•** å¤±è´¥ï¼Œè¿”å› 401 æœªæˆæƒ
2. **OAuth å‘ç°** æ‰¾åˆ°æˆæƒå’Œä»¤ç‰Œç«¯ç‚¹
3. **æµè§ˆå™¨æ‰“å¼€** ç”¨äºç”¨æˆ·èº«ä»½éªŒè¯ï¼ˆéœ€è¦æœ¬åœ°æµè§ˆå™¨è®¿é—®ï¼‰
4. **æˆæƒç ** å…‘æ¢ä¸ºè®¿é—®ä»¤ç‰Œ
5. **ä»¤ç‰Œå®‰å…¨å­˜å‚¨** ä»¥ä¾›å°†æ¥ä½¿ç”¨
6. **è¿æ¥é‡è¯•** ä½¿ç”¨æœ‰æ•ˆä»¤ç‰ŒæˆåŠŸ

#### æµè§ˆå™¨é‡å®šå‘è¦æ±‚

**é‡è¦ï¼š** OAuth èº«ä»½éªŒè¯è¦æ±‚æ‚¨çš„æœ¬åœ°æœºå™¨èƒ½å¤Ÿï¼š

- æ‰“å¼€ Web æµè§ˆå™¨è¿›è¡Œèº«ä»½éªŒè¯
- åœ¨ `http://localhost:7777/oauth/callback` ä¸Šæ¥æ”¶é‡å®šå‘

æ­¤åŠŸèƒ½åœ¨ä»¥ä¸‹ç¯å¢ƒä¸­æ— æ³•å·¥ä½œï¼š

- æ²¡æœ‰æµè§ˆå™¨è®¿é—®æƒé™çš„æ— å¤´ç¯å¢ƒ
- æ²¡æœ‰ X11 è½¬å‘çš„è¿œç¨‹ SSH ä¼šè¯
- æ²¡æœ‰æµè§ˆå™¨æ”¯æŒçš„å®¹å™¨åŒ–ç¯å¢ƒ

#### ç®¡ç† OAuth èº«ä»½éªŒè¯

ä½¿ç”¨ `/mcp auth` å‘½ä»¤ç®¡ç† OAuth èº«ä»½éªŒè¯ï¼š

```bash
# åˆ—å‡ºéœ€è¦èº«ä»½éªŒè¯çš„æœåŠ¡å™¨
/mcp auth

# ä½¿ç”¨ç‰¹å®šæœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯
/mcp auth serverName

# å¦‚æœä»¤ç‰Œè¿‡æœŸåˆ™é‡æ–°è¿›è¡Œèº«ä»½éªŒè¯
/mcp auth serverName
```

#### OAuth é…ç½®å±æ€§

- **`enabled`** (å¸ƒå°”å€¼): ä¸ºæ­¤æœåŠ¡å™¨å¯ç”¨ OAuth
- **`clientId`** (å­—ç¬¦ä¸²): OAuth å®¢æˆ·ç«¯æ ‡è¯†ç¬¦ï¼ˆå¯é€‰ï¼Œä½¿ç”¨åŠ¨æ€æ³¨å†Œæ—¶ï¼‰
- **`clientSecret`** (å­—ç¬¦ä¸²): OAuth å®¢æˆ·ç«¯å¯†é’¥ï¼ˆå¯é€‰ï¼Œç”¨äºå…¬å…±å®¢æˆ·ç«¯ï¼‰
- **`authorizationUrl`** (å­—ç¬¦ä¸²): OAuth æˆæƒç«¯ç‚¹ï¼ˆå¦‚æœçœç•¥åˆ™è‡ªåŠ¨å‘ç°ï¼‰
- **`tokenUrl`** (å­—ç¬¦ä¸²): OAuth ä»¤ç‰Œç«¯ç‚¹ï¼ˆå¦‚æœçœç•¥åˆ™è‡ªåŠ¨å‘ç°ï¼‰
- **`scopes`** (å­—ç¬¦ä¸²[]): æ‰€éœ€çš„ OAuth èŒƒå›´
- **`redirectUri`** (å­—ç¬¦ä¸²): è‡ªå®šä¹‰é‡å®šå‘ URIï¼ˆé»˜è®¤ä¸º `http://localhost:7777/oauth/callback`ï¼‰
- **`tokenParamName`** (å­—ç¬¦ä¸²): SSE URL ä¸­ä»¤ç‰Œçš„æŸ¥è¯¢å‚æ•°åç§°
- **`audiences`** (å­—ç¬¦ä¸²[]): ä»¤ç‰Œæœ‰æ•ˆçš„å—ä¼—

#### ä»¤ç‰Œç®¡ç†

OAuth ä»¤ç‰Œä¼šè‡ªåŠ¨ï¼š

- **å®‰å…¨å­˜å‚¨** åœ¨ `~/.ve/mcp-oauth-tokens.json` ä¸­
- **åˆ·æ–°** å½“è¿‡æœŸæ—¶ï¼ˆå¦‚æœæœ‰åˆ·æ–°ä»¤ç‰Œå¯ç”¨ï¼‰
- **éªŒè¯** åœ¨æ¯æ¬¡è¿æ¥å°è¯•ä¹‹å‰
- **æ¸…ç†** å½“æ— æ•ˆæˆ–è¿‡æœŸæ—¶

#### èº«ä»½éªŒè¯æä¾›è€…ç±»å‹

æ‚¨å¯ä»¥ä½¿ç”¨ `authProviderType` å±æ€§æŒ‡å®šèº«ä»½éªŒè¯æä¾›è€…ç±»å‹ï¼š

- **`authProviderType`** (å­—ç¬¦ä¸²): æŒ‡å®šèº«ä»½éªŒè¯æä¾›è€…ã€‚å¯ä»¥æ˜¯ä»¥ä¸‹ä¹‹ä¸€ï¼š
  - **`dynamic_discovery`** (é»˜è®¤): CLI å°†è‡ªåŠ¨ä»æœåŠ¡å™¨å‘ç° OAuth é…ç½®ã€‚
  - **`volcengine_credentials`**: CLI å°†ä½¿ç”¨ Volcengine åº”ç”¨é»˜è®¤å‡­æ® (ADC) å¯¹æœåŠ¡å™¨è¿›è¡Œèº«ä»½éªŒè¯ã€‚ä½¿ç”¨æ­¤æä¾›è€…æ—¶ï¼Œæ‚¨å¿…é¡»æŒ‡å®šæ‰€éœ€çš„èŒƒå›´ã€‚

```json
{
  "mcpServers": {
    "volcengineServer": {
      "httpUrl": "https://my-gcp-service.run.app/mcp",
      "authProviderType": "volcengine_credentials",
      "oauth": {
        "scopes": ["https://www.volcengineapis.com/auth/userinfo.email"]
      }
    }
  }
}
```

### ç¤ºä¾‹é…ç½®

#### Python MCP æœåŠ¡å™¨ (Stdio)

```json
{
  "mcpServers": {
    "pythonTools": {
      "command": "python",
      "args": ["-m", "my_mcp_server", "--port", "8080"],
      "cwd": "./mcp-servers/python",
      "env": {
        "DATABASE_URL": "$DB_CONNECTION_STRING",
        "API_KEY": "${EXTERNAL_API_KEY}"
      },
      "timeout": 15000
    }
  }
}
```

#### Node.js MCP æœåŠ¡å™¨ (Stdio)

```json
{
  "mcpServers": {
    "nodeServer": {
      "command": "node",
      "args": ["dist/server.js", "--verbose"],
      "cwd": "./mcp-servers/node",
      "trust": true
    }
  }
}
```

#### åŸºäº Docker çš„ MCP æœåŠ¡å™¨

```json
{
  "mcpServers": {
    "dockerizedServer": {
      "command": "docker",
      "args": [
        "run",
        "-i",
        "--rm",
        "-e",
        "API_KEY",
        "-v",
        "${PWD}:/workspace",
        "my-mcp-server:latest"
      ],
      "env": {
        "API_KEY": "$EXTERNAL_SERVICE_TOKEN"
      }
    }
  }
}
```

#### åŸºäº HTTP çš„ MCP æœåŠ¡å™¨

```json
{
  "mcpServers": {
    "httpServer": {
      "httpUrl": "http://localhost:3000/mcp",
      "timeout": 5000
    }
  }
}
```

#### å¸¦æœ‰è‡ªå®šä¹‰æ ‡å¤´çš„åŸºäº HTTP çš„ MCP æœåŠ¡å™¨

```json
{
  "mcpServers": {
    "httpServerWithAuth": {
      "httpUrl": "http://localhost:3000/mcp",
      "headers": {
        "Authorization": "Bearer your-api-token",
        "X-Custom-Header": "custom-value",
        "Content-Type": "application/json"
      },
      "timeout": 5000
    }
  }
}
```

#### å¸¦æœ‰å·¥å…·è¿‡æ»¤çš„ MCP æœåŠ¡å™¨

```json
{
  "mcpServers": {
    "filteredServer": {
      "command": "python",
      "args": ["-m", "my_mcp_server"],
      "includeTools": ["safe_tool", "file_reader", "data_processor"],
      // "excludeTools": ["dangerous_tool", "file_deleter"],
      "timeout": 30000
    }
  }
}
```

## å‘ç°é˜¶æ®µæ·±å…¥

å½“ VeCLI å¯åŠ¨æ—¶ï¼Œå®ƒé€šè¿‡ä»¥ä¸‹è¯¦ç»†è¿‡ç¨‹æ‰§è¡Œ MCP æœåŠ¡å™¨å‘ç°ï¼š

### 1. æœåŠ¡å™¨è¿­ä»£å’Œè¿æ¥

å¯¹äº `mcpServers` ä¸­é…ç½®çš„æ¯ä¸ªæœåŠ¡å™¨ï¼š

1. **çŠ¶æ€è·Ÿè¸ªå¼€å§‹ï¼š** æœåŠ¡å™¨çŠ¶æ€è®¾ç½®ä¸º `CONNECTING`
2. **ä¼ è¾“é€‰æ‹©ï¼š** åŸºäºé…ç½®å±æ€§ï¼š
   - `httpUrl` â†’ `StreamableHTTPClientTransport`
   - `url` â†’ `SSEClientTransport`
   - `command` â†’ `StdioClientTransport`
3. **è¿æ¥å»ºç«‹ï¼š** MCP å®¢æˆ·ç«¯å°è¯•ä½¿ç”¨é…ç½®çš„è¶…æ—¶è¿æ¥
4. **é”™è¯¯å¤„ç†ï¼š** è¿æ¥å¤±è´¥ä¼šè¢«è®°å½•ï¼ŒæœåŠ¡å™¨çŠ¶æ€è®¾ç½®ä¸º `DISCONNECTED`

### 2. å·¥å…·å‘ç°

è¿æ¥æˆåŠŸåï¼š

1. **å·¥å…·åˆ—è¡¨ï¼š** å®¢æˆ·ç«¯è°ƒç”¨ MCP æœåŠ¡å™¨çš„å·¥å…·åˆ—è¡¨ç«¯ç‚¹
2. **æ¨¡å¼éªŒè¯ï¼š** éªŒè¯æ¯ä¸ªå·¥å…·çš„å‡½æ•°å£°æ˜
3. **å·¥å…·è¿‡æ»¤ï¼š** æ ¹æ® `includeTools` å’Œ `excludeTools` é…ç½®è¿‡æ»¤å·¥å…·
4. **åç§°æ¸…ç†ï¼š** å·¥å…·åç§°è¢«æ¸…ç†ä»¥æ»¡è¶³ Vecli API è¦æ±‚ï¼š
   - æ— æ•ˆå­—ç¬¦ï¼ˆéå­—æ¯æ•°å­—ã€ä¸‹åˆ’çº¿ã€ç‚¹ã€è¿å­—ç¬¦ï¼‰è¢«æ›¿æ¢ä¸ºä¸‹åˆ’çº¿
   - è¶…è¿‡ 63 ä¸ªå­—ç¬¦çš„åç§°ä¼šè¢«æˆªæ–­ï¼Œå¹¶ç”¨ä¸­é—´æ›¿æ¢ (`___`)

### 3. å†²çªè§£å†³

å½“å¤šä¸ªæœåŠ¡å™¨å…¬å¼€åŒåå·¥å…·æ—¶ï¼š

1. **é¦–æ¬¡æ³¨å†Œè·èƒœï¼š** ç¬¬ä¸€ä¸ªæ³¨å†Œå·¥å…·åç§°çš„æœåŠ¡å™¨è·å¾—æœªåŠ å‰ç¼€çš„åç§°
2. **è‡ªåŠ¨åŠ å‰ç¼€ï¼š** åç»­æœåŠ¡å™¨è·å¾—åŠ å‰ç¼€çš„åç§°ï¼š`serverName__toolName`
3. **æ³¨å†Œè¡¨è·Ÿè¸ªï¼š** å·¥å…·æ³¨å†Œè¡¨ç»´æŠ¤æœåŠ¡å™¨åç§°ä¸å…¶å·¥å…·ä¹‹é—´çš„æ˜ å°„

### 4. æ¨¡å¼å¤„ç†

å·¥å…·å‚æ•°æ¨¡å¼ç»è¿‡æ¸…ç†ä»¥ç¡®ä¿ä¸ Vecli API å…¼å®¹ï¼š

- **`$schema` å±æ€§** è¢«ç§»é™¤
- **`additionalProperties`** è¢«å‰¥ç¦»
- **å¸¦æœ‰ `default` çš„ `anyOf`** å…¶é»˜è®¤å€¼è¢«ç§»é™¤ï¼ˆVertex AI å…¼å®¹æ€§ï¼‰
- **é€’å½’å¤„ç†** åº”ç”¨äºåµŒå¥—æ¨¡å¼

### 5. è¿æ¥ç®¡ç†

å‘ç°åï¼š

- **æŒä¹…è¿æ¥ï¼š** æˆåŠŸæ³¨å†Œå·¥å…·çš„æœåŠ¡å™¨ä¿æŒå…¶è¿æ¥
- **æ¸…ç†ï¼š** ä¸æä¾›å¯ç”¨å·¥å…·çš„æœåŠ¡å™¨çš„è¿æ¥ä¼šè¢«å…³é—­
- **çŠ¶æ€æ›´æ–°ï¼š** æœ€ç»ˆæœåŠ¡å™¨çŠ¶æ€è®¾ç½®ä¸º `CONNECTED` æˆ– `DISCONNECTED`

## å·¥å…·æ‰§è¡Œæµç¨‹

å½“ Vecli æ¨¡å‹å†³å®šä½¿ç”¨ MCP å·¥å…·æ—¶ï¼Œä¼šå‘ç”Ÿä»¥ä¸‹æ‰§è¡Œæµç¨‹ï¼š

### 1. å·¥å…·è°ƒç”¨

æ¨¡å‹ç”Ÿæˆä¸€ä¸ª `FunctionCall`ï¼Œå…¶ä¸­åŒ…å«ï¼š

- **å·¥å…·åç§°ï¼š** æ³¨å†Œçš„åç§°ï¼ˆå¯èƒ½åŠ äº†å‰ç¼€ï¼‰
- **å‚æ•°ï¼š** ä¸å·¥å…·å‚æ•°æ¨¡å¼åŒ¹é…çš„ JSON å¯¹è±¡

### 2. ç¡®è®¤è¿‡ç¨‹

æ¯ä¸ª `DiscoveredMCPTool` å®ç°äº†å¤æ‚çš„ç¡®è®¤é€»è¾‘ï¼š

#### åŸºäºä¿¡ä»»çš„ç»•è¿‡

```typescript
if (this.trust) {
  return false; // æ— éœ€ç¡®è®¤
}
```

#### åŠ¨æ€å…è®¸åˆ—è¡¨

ç³»ç»Ÿä¸ºä»¥ä¸‹å†…å®¹ç»´æŠ¤å†…éƒ¨å…è®¸åˆ—è¡¨ï¼š

- **æœåŠ¡å™¨çº§åˆ«ï¼š** `serverName` â†’ æ¥è‡ªæ­¤æœåŠ¡å™¨çš„æ‰€æœ‰å·¥å…·éƒ½è¢«ä¿¡ä»»
- **å·¥å…·çº§åˆ«ï¼š** `serverName.toolName` â†’ æ­¤ç‰¹å®šå·¥å…·è¢«ä¿¡ä»»

#### ç”¨æˆ·é€‰æ‹©å¤„ç†

éœ€è¦ç¡®è®¤æ—¶ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©ï¼š

- **ä»…æ­¤ä¸€æ¬¡ï¼š** ä»…æ‰§è¡Œè¿™ä¸€æ¬¡
- **å§‹ç»ˆå…è®¸æ­¤å·¥å…·ï¼š** æ·»åŠ åˆ°å·¥å…·çº§åˆ«å…è®¸åˆ—è¡¨
- **å§‹ç»ˆå…è®¸æ­¤æœåŠ¡å™¨ï¼š** æ·»åŠ åˆ°æœåŠ¡å™¨çº§åˆ«å…è®¸åˆ—è¡¨
- **å–æ¶ˆï¼š** ä¸­æ­¢æ‰§è¡Œ

### 3. æ‰§è¡Œ

ç¡®è®¤åï¼ˆæˆ–ä¿¡ä»»ç»•è¿‡ï¼‰ï¼š

1. **å‚æ•°å‡†å¤‡ï¼š** å‚æ•°æ ¹æ®å·¥å…·çš„æ¨¡å¼è¿›è¡ŒéªŒè¯
2. **MCP è°ƒç”¨ï¼š** åº•å±‚ `CallableTool` ä½¿ç”¨ä»¥ä¸‹å†…å®¹è°ƒç”¨æœåŠ¡å™¨ï¼š

   ```typescript
   const functionCalls = [
     {
       name: this.serverToolName, // åŸå§‹æœåŠ¡å™¨å·¥å…·åç§°
       args: params,
     },
   ];
   ```

3. **å“åº”å¤„ç†ï¼š** ç»“æœè¢«æ ¼å¼åŒ–ä¸º LLM ä¸Šä¸‹æ–‡å’Œç”¨æˆ·æ˜¾ç¤º

### 4. å“åº”å¤„ç†

æ‰§è¡Œç»“æœåŒ…å«ï¼š

- **`llmContent`ï¼š** ç”¨äºè¯­è¨€æ¨¡å‹ä¸Šä¸‹æ–‡çš„åŸå§‹å“åº”éƒ¨åˆ†
- **`returnDisplay`ï¼š** ç”¨äºç”¨æˆ·æ˜¾ç¤ºçš„æ ¼å¼åŒ–è¾“å‡ºï¼ˆé€šå¸¸æ˜¯ JSON æ ¼å¼çš„ä»£ç å—ï¼‰

## å¦‚ä½•ä¸æ‚¨çš„ MCP æœåŠ¡å™¨äº¤äº’

### ä½¿ç”¨ `/mcp` å‘½ä»¤

`/mcp` å‘½ä»¤æä¾›æœ‰å…³ MCP æœåŠ¡å™¨è®¾ç½®çš„å…¨é¢ä¿¡æ¯ï¼š

```bash
/mcp
```

è¿™å°†æ˜¾ç¤ºï¼š

- **æœåŠ¡å™¨åˆ—è¡¨ï¼š** æ‰€æœ‰é…ç½®çš„ MCP æœåŠ¡å™¨
- **è¿æ¥çŠ¶æ€ï¼š** `CONNECTED`ã€`CONNECTING` æˆ– `DISCONNECTED`
- **æœåŠ¡å™¨è¯¦ç»†ä¿¡æ¯ï¼š** é…ç½®æ‘˜è¦ï¼ˆä¸åŒ…æ‹¬æ•æ„Ÿæ•°æ®ï¼‰
- **å¯ç”¨å·¥å…·ï¼š** æ¯ä¸ªæœåŠ¡å™¨çš„å·¥å…·åˆ—è¡¨åŠå…¶æè¿°
- **å‘ç°çŠ¶æ€ï¼š** æ•´ä½“å‘ç°è¿‡ç¨‹çŠ¶æ€

### ç¤ºä¾‹ `/mcp` è¾“å‡º

```
MCP æœåŠ¡å™¨çŠ¶æ€:

ğŸ“¡ pythonTools (å·²è¿æ¥)
  å‘½ä»¤: python -m my_mcp_server --port 8080
  å·¥ä½œç›®å½•: ./mcp-servers/python
  è¶…æ—¶: 15000ms
  å·¥å…·: calculate_sum, file_analyzer, data_processor

ğŸ”Œ nodeServer (å·²æ–­å¼€)
  å‘½ä»¤: node dist/server.js --verbose
  é”™è¯¯: è¿æ¥è¢«æ‹’ç»

ğŸ³ dockerizedServer (å·²è¿æ¥)
  å‘½ä»¤: docker run -i --rm -e API_KEY my-mcp-server:latest
  å·¥å…·: docker__deploy, docker__status

å‘ç°çŠ¶æ€: å·²å®Œæˆ
```

### å·¥å…·ä½¿ç”¨

å‘ç°åï¼ŒMCP å·¥å…·å¯¹ Vecli æ¨¡å‹æ¥è¯´å°±åƒå†…ç½®å·¥å…·ä¸€æ ·å¯ç”¨ã€‚æ¨¡å‹å°†è‡ªåŠ¨ï¼š

1. **é€‰æ‹©åˆé€‚çš„å·¥å…·** åŸºäºæ‚¨çš„è¯·æ±‚
2. **æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†** ï¼ˆé™¤éæœåŠ¡å™¨å—ä¿¡ä»»ï¼‰
3. **æ‰§è¡Œå·¥å…·** ä½¿ç”¨æ­£ç¡®çš„å‚æ•°
4. **ä»¥ç”¨æˆ·å‹å¥½çš„æ ¼å¼æ˜¾ç¤ºç»“æœ**

## çŠ¶æ€ç›‘æ§å’Œæ•…éšœæ’é™¤

### è¿æ¥çŠ¶æ€

MCP é›†æˆè·Ÿè¸ªå‡ ç§çŠ¶æ€ï¼š

#### æœåŠ¡å™¨çŠ¶æ€ (`MCPServerStatus`)

- **`DISCONNECTED`:** æœåŠ¡å™¨æœªè¿æ¥æˆ–æœ‰é”™è¯¯
- **`CONNECTING`:** æ­£åœ¨è¿›è¡Œè¿æ¥å°è¯•
- **`CONNECTED`:** æœåŠ¡å™¨å·²è¿æ¥å¹¶å‡†å¤‡å°±ç»ª

#### å‘ç°çŠ¶æ€ (`MCPDiscoveryState`)

- **`NOT_STARTED`:** å‘ç°å°šæœªå¼€å§‹
- **`IN_PROGRESS`:** å½“å‰æ­£åœ¨å‘ç°æœåŠ¡å™¨
- **`COMPLETED`:** å‘ç°å·²å®Œæˆï¼ˆæœ‰æˆ–æ²¡æœ‰é”™è¯¯ï¼‰

### å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

#### æœåŠ¡å™¨æ— æ³•è¿æ¥

**ç—‡çŠ¶ï¼š** æœåŠ¡å™¨æ˜¾ç¤º `DISCONNECTED` çŠ¶æ€

**æ•…éšœæ’é™¤ï¼š**

1. **æ£€æŸ¥é…ç½®ï¼š** éªŒè¯ `command`ã€`args` å’Œ `cwd` æ˜¯å¦æ­£ç¡®
2. **æ‰‹åŠ¨æµ‹è¯•ï¼š** ç›´æ¥è¿è¡ŒæœåŠ¡å™¨å‘½ä»¤ä»¥ç¡®ä¿å…¶æ­£å¸¸å·¥ä½œ
3. **æ£€æŸ¥ä¾èµ–é¡¹ï¼š** ç¡®ä¿æ‰€æœ‰å¿…éœ€çš„åŒ…éƒ½å·²å®‰è£…
4. **æŸ¥çœ‹æ—¥å¿—ï¼š** åœ¨ CLI è¾“å‡ºä¸­æŸ¥æ‰¾é”™è¯¯æ¶ˆæ¯
5. **éªŒè¯æƒé™ï¼š** ç¡®ä¿ CLI å¯ä»¥æ‰§è¡ŒæœåŠ¡å™¨å‘½ä»¤

#### æœªå‘ç°å·¥å…·

**ç—‡çŠ¶ï¼š** æœåŠ¡å™¨è¿æ¥ä½†æ²¡æœ‰å¯ç”¨çš„å·¥å…·

**æ•…éšœæ’é™¤ï¼š**

1. **éªŒè¯å·¥å…·æ³¨å†Œï¼š** ç¡®ä¿æ‚¨çš„æœåŠ¡å™¨å®é™…æ³¨å†Œäº†å·¥å…·
2. **æ£€æŸ¥ MCP åè®®ï¼š** ç¡®è®¤æ‚¨çš„æœåŠ¡å™¨æ­£ç¡®å®ç°äº† MCP å·¥å…·åˆ—è¡¨
3. **æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼š** æ£€æŸ¥ stderr è¾“å‡ºä»¥æŸ¥æ‰¾æœåŠ¡å™¨ç«¯é”™è¯¯
4. **æµ‹è¯•å·¥å…·åˆ—è¡¨ï¼š** æ‰‹åŠ¨æµ‹è¯•æœåŠ¡å™¨çš„å·¥å…·å‘ç°ç«¯ç‚¹

#### å·¥å…·æ— æ³•æ‰§è¡Œ

**ç—‡çŠ¶ï¼š** å·¥å…·è¢«å‘ç°ä½†åœ¨æ‰§è¡ŒæœŸé—´å¤±è´¥

**æ•…éšœæ’é™¤ï¼š**

1. **å‚æ•°éªŒè¯ï¼š** ç¡®ä¿æ‚¨çš„å·¥å…·æ¥å—é¢„æœŸçš„å‚æ•°
2. **æ¨¡å¼å…¼å®¹æ€§ï¼š** éªŒè¯æ‚¨çš„è¾“å…¥æ¨¡å¼æ˜¯æœ‰æ•ˆçš„ JSON æ¨¡å¼
3. **é”™è¯¯å¤„ç†ï¼š** æ£€æŸ¥æ‚¨çš„å·¥å…·æ˜¯å¦æŠ›å‡ºæœªå¤„ç†çš„å¼‚å¸¸
4. **è¶…æ—¶é—®é¢˜ï¼š** è€ƒè™‘å¢åŠ  `timeout` è®¾ç½®

#### æ²™ç›’å…¼å®¹æ€§

**ç—‡çŠ¶ï¼š** å¯ç”¨æ²™ç›’æ—¶ MCP æœåŠ¡å™¨å¤±è´¥

**è§£å†³æ–¹æ¡ˆï¼š**

1. **åŸºäº Docker çš„æœåŠ¡å™¨ï¼š** ä½¿ç”¨åŒ…å«æ‰€æœ‰ä¾èµ–é¡¹çš„ Docker å®¹å™¨
2. **è·¯å¾„å¯è®¿é—®æ€§ï¼š** ç¡®ä¿æ²™ç›’ç¯å¢ƒä¸­å¯ä»¥è®¿é—®æœåŠ¡å™¨å¯æ‰§è¡Œæ–‡ä»¶
3. **ç½‘ç»œè®¿é—®ï¼š** é…ç½®æ²™ç›’ä»¥å…è®¸å¿…è¦çš„ç½‘ç»œè¿æ¥
4. **ç¯å¢ƒå˜é‡ï¼š** éªŒè¯æ‰€éœ€çš„ç¯å¢ƒå˜é‡æ˜¯å¦å·²ä¼ é€’

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼š** ä½¿ç”¨ `--debug` è¿è¡Œ CLI ä»¥è·å–è¯¦ç»†è¾“å‡º
2. **æ£€æŸ¥ stderrï¼š** MCP æœåŠ¡å™¨ stderr è¢«æ•è·å¹¶è®°å½•ï¼ˆINFO æ¶ˆæ¯è¢«è¿‡æ»¤ï¼‰
3. **æµ‹è¯•éš”ç¦»ï¼š** åœ¨é›†æˆä¹‹å‰ç‹¬ç«‹æµ‹è¯•æ‚¨çš„ MCP æœåŠ¡å™¨
4. **å¢é‡è®¾ç½®ï¼š** åœ¨æ·»åŠ å¤æ‚åŠŸèƒ½ä¹‹å‰ä»ç®€å•å·¥å…·å¼€å§‹
5. **é¢‘ç¹ä½¿ç”¨ `/mcp`ï¼š** åœ¨å¼€å‘è¿‡ç¨‹ä¸­ç›‘æ§æœåŠ¡å™¨çŠ¶æ€

## é‡è¦è¯´æ˜

### å®‰å…¨æ³¨æ„äº‹é¡¹

- **ä¿¡ä»»è®¾ç½®ï¼š** `trust` é€‰é¡¹ç»•è¿‡æ‰€æœ‰ç¡®è®¤å¯¹è¯æ¡†ã€‚è¯·è°¨æ…ä½¿ç”¨ï¼Œä»…ç”¨äºæ‚¨å®Œå…¨æ§åˆ¶çš„æœåŠ¡å™¨
- **è®¿é—®ä»¤ç‰Œï¼š** é…ç½®åŒ…å« API å¯†é’¥æˆ–ä»¤ç‰Œçš„ç¯å¢ƒå˜é‡æ—¶è¦æ³¨æ„å®‰å…¨
- **æ²™ç›’å…¼å®¹æ€§ï¼š** ä½¿ç”¨æ²™ç›’æ—¶ï¼Œç¡®ä¿ MCP æœåŠ¡å™¨åœ¨æ²™ç›’ç¯å¢ƒä¸­å¯ç”¨
- **ç§äººæ•°æ®ï¼š** ä½¿ç”¨èŒƒå›´å¹¿æ³›çš„ä¸ªäººè®¿é—®ä»¤ç‰Œå¯èƒ½å¯¼è‡´å­˜å‚¨åº“ä¹‹é—´çš„ä¿¡æ¯æ³„éœ²

### æ€§èƒ½å’Œèµ„æºç®¡ç†

- **è¿æ¥æŒä¹…æ€§ï¼š** CLI ä¿æŒä¸æˆåŠŸæ³¨å†Œå·¥å…·çš„æœåŠ¡å™¨çš„æŒä¹…è¿æ¥
- **è‡ªåŠ¨æ¸…ç†ï¼š** åˆ°ä¸æä¾›å·¥å…·çš„æœåŠ¡å™¨çš„è¿æ¥ä¼šè‡ªåŠ¨å…³é—­
- **è¶…æ—¶ç®¡ç†ï¼š** æ ¹æ®æœåŠ¡å™¨çš„å“åº”ç‰¹æ€§é…ç½®é€‚å½“çš„è¶…æ—¶
- **èµ„æºç›‘æ§ï¼š** MCP æœåŠ¡å™¨ä½œä¸ºå•ç‹¬çš„è¿›ç¨‹è¿è¡Œå¹¶æ¶ˆè€—ç³»ç»Ÿèµ„æº

### æ¨¡å¼å…¼å®¹æ€§

- **å±æ€§å‰¥ç¦»ï¼š** ç³»ç»Ÿä¼šè‡ªåŠ¨ç§»é™¤æŸäº›æ¨¡å¼å±æ€§ï¼ˆ`$schema`ã€`additionalProperties`ï¼‰ä»¥ç¡®ä¿ä¸ Vecli API å…¼å®¹
- **åç§°æ¸…ç†ï¼š** å·¥å…·åç§°ä¼šè‡ªåŠ¨æ¸…ç†ä»¥æ»¡è¶³ API è¦æ±‚
- **å†²çªè§£å†³ï¼š** æœåŠ¡å™¨ä¹‹é—´çš„å·¥å…·åç§°å†²çªé€šè¿‡è‡ªåŠ¨åŠ å‰ç¼€è§£å†³

è¿™ç§å…¨é¢çš„é›†æˆä½¿ MCP æœåŠ¡å™¨æˆä¸ºæ‰©å±• VeCLI åŠŸèƒ½çš„å¼ºå¤§æ–¹å¼ï¼ŒåŒæ—¶ä¿æŒå®‰å…¨æ€§ã€å¯é æ€§å’Œæ˜“ç”¨æ€§ã€‚

## ä»å·¥å…·è¿”å›å¯Œå†…å®¹

MCP å·¥å…·ä¸ä»…é™äºè¿”å›ç®€å•æ–‡æœ¬ã€‚æ‚¨å¯ä»¥è¿”å›å¯Œå¤šéƒ¨åˆ†å†…å®¹ï¼ŒåŒ…æ‹¬æ–‡æœ¬ã€å›¾åƒã€éŸ³é¢‘å’Œå…¶ä»–äºŒè¿›åˆ¶æ•°æ®ï¼Œä½œä¸ºå•ä¸ªå·¥å…·å“åº”ã€‚è¿™ä½¿æ‚¨èƒ½å¤Ÿæ„å»ºå¼ºå¤§çš„å·¥å…·ï¼Œå¯ä»¥åœ¨å•ä¸ªå›åˆä¸­å‘æ¨¡å‹æä¾›å¤šæ ·åŒ–çš„ä¿¡æ¯ã€‚

æ‰€æœ‰ä»å·¥å…·è¿”å›çš„æ•°æ®éƒ½ä¼šè¢«å¤„ç†å¹¶ä½œä¸ºä¸Šä¸‹æ–‡å‘é€ç»™æ¨¡å‹ï¼Œä»¥ä¾›å…¶ä¸‹ä¸€æ¬¡ç”Ÿæˆä½¿ç”¨ï¼Œä½¿å…¶èƒ½å¤Ÿæ¨ç†æˆ–æ€»ç»“æä¾›çš„ä¿¡æ¯ã€‚

### å·¥ä½œåŸç†

è¦è¿”å›å¯Œå†…å®¹ï¼Œæ‚¨çš„å·¥å…·å“åº”å¿…é¡»éµå¾ª MCP è§„èŒƒä¸­çš„ [`CallToolResult`](https://modelcontextprotocol.io/specification/2025-06-18/server/tools#tool-result)ã€‚ç»“æœçš„ `content` å­—æ®µåº”è¯¥æ˜¯ä¸€ä¸ª `ContentBlock` å¯¹è±¡æ•°ç»„ã€‚VeCLI å°†æ­£ç¡®å¤„ç†æ­¤æ•°ç»„ï¼Œå°†æ–‡æœ¬ä¸äºŒè¿›åˆ¶æ•°æ®åˆ†ç¦»å¹¶æ‰“åŒ…ç»™æ¨¡å‹ã€‚

æ‚¨å¯ä»¥åœ¨ `content` æ•°ç»„ä¸­æ··åˆå’ŒåŒ¹é…ä¸åŒçš„å†…å®¹å—ç±»å‹ã€‚æ”¯æŒçš„å—ç±»å‹åŒ…æ‹¬ï¼š

- `text`
- `image`
- `audio`
- `resource` (åµŒå…¥å†…å®¹)
- `resource_link`

### ç¤ºä¾‹ï¼šè¿”å›æ–‡æœ¬å’Œå›¾åƒ

ä»¥ä¸‹æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ MCP å·¥å…· JSON å“åº”ç¤ºä¾‹ï¼Œè¯¥å“åº”åŒæ—¶è¿”å›æ–‡æœ¬æè¿°å’Œå›¾åƒï¼š

```json
{
  "content": [
    {
      "type": "text",
      "text": "è¿™æ˜¯æ‚¨è¯·æ±‚çš„å¾½æ ‡ã€‚"
    },
    {
      "type": "image",
      "data": "BASE64_ENCODED_IMAGE_DATA_HERE",
      "mimeType": "image/png"
    },
    {
      "type": "text",
      "text": "å¾½æ ‡äº 2025 å¹´åˆ›å»ºã€‚"
    }
  ]
}
```

å½“ VeCLI æ”¶åˆ°æ­¤å“åº”æ—¶ï¼Œå®ƒå°†ï¼š

1.  æå–æ‰€æœ‰æ–‡æœ¬å¹¶å°†å…¶ç»„åˆæˆä¸€ä¸ª `functionResponse` éƒ¨åˆ†ä¾›æ¨¡å‹ä½¿ç”¨ã€‚
2.  å°†å›¾åƒæ•°æ®ä½œä¸ºå•ç‹¬çš„ `inlineData` éƒ¨åˆ†å‘ˆç°ã€‚
3.  åœ¨ CLI ä¸­æä¾›ä¸€ä¸ªå¹²å‡€ã€ç”¨æˆ·å‹å¥½çš„æ‘˜è¦ï¼Œè¡¨æ˜å·²æ”¶åˆ°æ–‡æœ¬å’Œå›¾åƒã€‚

è¿™ä½¿æ‚¨èƒ½å¤Ÿæ„å»ºå¤æ‚çš„å·¥å…·ï¼Œå‘ Vecli æ¨¡å‹æä¾›ä¸°å¯Œçš„å¤šæ¨¡æ€ä¸Šä¸‹æ–‡ã€‚

## ä½œä¸ºæ–œæ å‘½ä»¤çš„ MCP æç¤º

é™¤äº†å·¥å…·ï¼ŒMCP æœåŠ¡å™¨è¿˜å¯ä»¥å…¬å¼€é¢„å®šä¹‰çš„æç¤ºï¼Œè¿™äº›æç¤ºå¯ä»¥åœ¨ VeCLI ä¸­ä½œä¸ºæ–œæ å‘½ä»¤æ‰§è¡Œã€‚è¿™ä½¿æ‚¨èƒ½å¤Ÿä¸ºå¸¸è§æˆ–å¤æ‚çš„æŸ¥è¯¢åˆ›å»ºå¿«æ·æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡åç§°è½»æ¾è°ƒç”¨ã€‚

### åœ¨æœåŠ¡å™¨ä¸Šå®šä¹‰æç¤º

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®šä¹‰æç¤ºçš„å°å‹ stdio MCP æœåŠ¡å™¨ç¤ºä¾‹ï¼š

```ts
import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js';
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js';
import { z } from 'zod';

const server = new McpServer({
  name: 'prompt-server',
  version: '1.0.0',
});

server.registerPrompt(
  'poem-writer',
  {
    title: 'è¯—æ­Œä½œå®¶',
    description: 'å†™ä¸€é¦–ä¼˜ç¾çš„ä¿³å¥',
    argsSchema: { title: z.string(), mood: z.string().optional() },
  },
  ({ title, mood }) => ({
    messages: [
      {
        role: 'user',
        content: {
          type: 'text',
          text: `å†™ä¸€é¦–ä¿³å¥${mood ? `ï¼Œæƒ…ç»ªä¸º ${mood}` : ''}ï¼Œæ ‡é¢˜ä¸º ${title}ã€‚è¯·æ³¨æ„ï¼Œä¿³å¥æ˜¯ 5 ä¸ªéŸ³èŠ‚ï¼Œç„¶åæ˜¯ 7 ä¸ªéŸ³èŠ‚ï¼Œå†ç„¶åæ˜¯ 5 ä¸ªéŸ³èŠ‚ `,
        },
      },
    ],
  }),
);

const transport = new StdioServerTransport();
await server.connect(transport);
```

è¿™å¯ä»¥åœ¨ `settings.json` ä¸­çš„ `mcpServers` ä¸‹åŒ…å«ï¼š

```json
{
  "mcpServers": {
    "nodeServer": {
      "command": "node",
      "args": ["filename.ts"]
    }
  }
}
```

### è°ƒç”¨æç¤º

å‘ç°æç¤ºåï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å…¶åç§°ä½œä¸ºæ–œæ å‘½ä»¤æ¥è°ƒç”¨å®ƒã€‚CLI å°†è‡ªåŠ¨å¤„ç†å‚æ•°è§£æã€‚

```bash
/poem-writer --title="VeCLI" --mood="reverent"
```

æˆ–è€…ï¼Œä½¿ç”¨ä½ç½®å‚æ•°ï¼š

```bash
/poem-writer "VeCLI" reverent
```

è¿è¡Œæ­¤å‘½ä»¤æ—¶ï¼ŒVeCLI åœ¨ MCP æœåŠ¡å™¨ä¸Šæ‰§è¡Œ `prompts/get` æ–¹æ³•å¹¶æä¾›å‚æ•°ã€‚æœåŠ¡å™¨è´Ÿè´£å°†å‚æ•°ä»£å…¥æç¤ºæ¨¡æ¿å¹¶è¿”å›æœ€ç»ˆæç¤ºæ–‡æœ¬ã€‚CLI ç„¶åå°†æ­¤æç¤ºå‘é€ç»™æ¨¡å‹æ‰§è¡Œã€‚è¿™æä¾›äº†ä¸€ç§æ–¹ä¾¿çš„æ–¹å¼æ¥è‡ªåŠ¨åŒ–å’Œå…±äº«å¸¸è§å·¥ä½œæµã€‚

## ä½¿ç”¨ `vecli mcp` ç®¡ç† MCP æœåŠ¡å™¨

è™½ç„¶æ‚¨æ€»æ˜¯å¯ä»¥é€šè¿‡æ‰‹åŠ¨ç¼–è¾‘ `settings.json` æ–‡ä»¶æ¥é…ç½® MCP æœåŠ¡å™¨ï¼Œä½† VeCLI æä¾›äº†ä¸€ç»„æ–¹ä¾¿çš„å‘½ä»¤æ¥ä»¥ç¼–ç¨‹æ–¹å¼ç®¡ç†æ‚¨çš„æœåŠ¡å™¨é…ç½®ã€‚è¿™äº›å‘½ä»¤ç®€åŒ–äº†æ·»åŠ ã€åˆ—å‡ºå’Œåˆ é™¤ MCP æœåŠ¡å™¨çš„è¿‡ç¨‹ï¼Œè€Œæ— éœ€ç›´æ¥ç¼–è¾‘ JSON æ–‡ä»¶ã€‚

### æ·»åŠ æœåŠ¡å™¨ (`vecli mcp add`)

`add` å‘½ä»¤åœ¨æ‚¨çš„ `settings.json` ä¸­é…ç½®ä¸€ä¸ªæ–°çš„ MCP æœåŠ¡å™¨ã€‚æ ¹æ®èŒƒå›´ (`-s, --scope`)ï¼Œå®ƒå°†è¢«æ·»åŠ åˆ°ç”¨æˆ·é…ç½® `~/.ve/settings.json` æˆ–é¡¹ç›®é…ç½® `.ve/settings.json` æ–‡ä»¶ä¸­ã€‚

**å‘½ä»¤ï¼š**

```bash
vecli mcp add [options] <name> <commandOrUrl> [args...]
```

- `<name>`: æœåŠ¡å™¨çš„å”¯ä¸€åç§°ã€‚
- `<commandOrUrl>`: è¦æ‰§è¡Œçš„å‘½ä»¤ï¼ˆç”¨äº `stdio`ï¼‰æˆ– URLï¼ˆç”¨äº `http`/`sse`ï¼‰ã€‚
- `[args...]`: `stdio` å‘½ä»¤çš„å¯é€‰å‚æ•°ã€‚

**é€‰é¡¹ï¼ˆæ ‡å¿—ï¼‰ï¼š**

- `-s, --scope`: é…ç½®èŒƒå›´ï¼ˆç”¨æˆ·æˆ–é¡¹ç›®ï¼‰ã€‚[é»˜è®¤: "project"]
- `-t, --transport`: ä¼ è¾“ç±»å‹ï¼ˆstdio, sse, httpï¼‰ã€‚[é»˜è®¤: "stdio"]
- `-e, --env`: è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆä¾‹å¦‚ -e KEY=valueï¼‰ã€‚
- `-H, --header`: ä¸º SSE å’Œ HTTP ä¼ è¾“è®¾ç½® HTTP æ ‡å¤´ï¼ˆä¾‹å¦‚ -H "X-Api-Key: abc123" -H "Authorization: Bearer abc123"ï¼‰ã€‚
- `--timeout`: è®¾ç½®è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ã€‚
- `--trust`: ä¿¡ä»»æœåŠ¡å™¨ï¼ˆç»•è¿‡æ‰€æœ‰å·¥å…·è°ƒç”¨ç¡®è®¤æç¤ºï¼‰ã€‚
- `--description`: è®¾ç½®æœåŠ¡å™¨çš„æè¿°ã€‚
- `--include-tools`: ä»¥é€—å·åˆ†éš”çš„è¦åŒ…å«çš„å·¥å…·åˆ—è¡¨ã€‚
- `--exclude-tools`: ä»¥é€—å·åˆ†éš”çš„è¦æ’é™¤çš„å·¥å…·åˆ—è¡¨ã€‚

#### æ·»åŠ ä¸€ä¸ª stdio æœåŠ¡å™¨

è¿™æ˜¯è¿è¡Œæœ¬åœ°æœåŠ¡å™¨çš„é»˜è®¤ä¼ è¾“ã€‚

```bash
# åŸºæœ¬è¯­æ³•
vecli mcp add <name> <command> [args...]

# ç¤ºä¾‹: æ·»åŠ ä¸€ä¸ªæœ¬åœ°æœåŠ¡å™¨
vecli mcp add my-stdio-server -e API_KEY=123 /path/to/server arg1 arg2 arg3

# ç¤ºä¾‹: æ·»åŠ ä¸€ä¸ªæœ¬åœ° python æœåŠ¡å™¨
vecli mcp add python-server python server.py --port 8080
```

#### æ·»åŠ ä¸€ä¸ª HTTP æœåŠ¡å™¨

æ­¤ä¼ è¾“ç”¨äºä½¿ç”¨å¯æµå¼ HTTP ä¼ è¾“çš„æœåŠ¡å™¨ã€‚

```bash
# åŸºæœ¬è¯­æ³•
vecli mcp add --transport http <name> <url>

# ç¤ºä¾‹: æ·»åŠ ä¸€ä¸ª HTTP æœåŠ¡å™¨
vecli mcp add --transport http http-server https://api.example.com/mcp/

# ç¤ºä¾‹: æ·»åŠ ä¸€ä¸ªå¸¦æœ‰èº«ä»½éªŒè¯æ ‡å¤´çš„ HTTP æœåŠ¡å™¨
vecli mcp add --transport http secure-http https://api.example.com/mcp/ --header "Authorization: Bearer abc123"
```

#### æ·»åŠ ä¸€ä¸ª SSE æœåŠ¡å™¨

æ­¤ä¼ è¾“ç”¨äºä½¿ç”¨æœåŠ¡å™¨å‘é€äº‹ä»¶ (SSE) çš„æœåŠ¡å™¨ã€‚

```bash
# åŸºæœ¬è¯­æ³•
vecli mcp add --transport sse <name> <url>

# ç¤ºä¾‹: æ·»åŠ ä¸€ä¸ª SSE æœåŠ¡å™¨
vecli mcp add --transport sse sse-server https://api.example.com/sse/

# ç¤ºä¾‹: æ·»åŠ ä¸€ä¸ªå¸¦æœ‰èº«ä»½éªŒè¯æ ‡å¤´çš„ SSE æœåŠ¡å™¨
vecli mcp add --transport sse secure-sse https://api.example.com/sse/ --header "Authorization: Bearer abc123"
```

### åˆ—å‡ºæœåŠ¡å™¨ (`vecli mcp list`)

è¦æŸ¥çœ‹å½“å‰é…ç½®çš„æ‰€æœ‰ MCP æœåŠ¡å™¨ï¼Œè¯·ä½¿ç”¨ `list` å‘½ä»¤ã€‚å®ƒæ˜¾ç¤ºæ¯ä¸ªæœåŠ¡å™¨çš„åç§°ã€é…ç½®è¯¦ç»†ä¿¡æ¯å’Œè¿æ¥çŠ¶æ€ã€‚

**å‘½ä»¤ï¼š**

```bash
vecli mcp list
```

**ç¤ºä¾‹è¾“å‡ºï¼š**

```sh
âœ“ stdio-server: å‘½ä»¤: python3 server.py (stdio) - å·²è¿æ¥
âœ“ http-server: https://api.example.com/mcp (http) - å·²è¿æ¥
âœ— sse-server: https://api.example.com/sse (sse) - å·²æ–­å¼€
```

### åˆ é™¤æœåŠ¡å™¨ (`vecli mcp remove`)

è¦ä»é…ç½®ä¸­åˆ é™¤æœåŠ¡å™¨ï¼Œè¯·ä½¿ç”¨ `remove` å‘½ä»¤å’ŒæœåŠ¡å™¨åç§°ã€‚

**å‘½ä»¤ï¼š**

```bash
vecli mcp remove <name>
```

**ç¤ºä¾‹ï¼š**

```bash
vecli mcp remove my-server
```

è¿™å°†æ ¹æ®èŒƒå›´ (`-s, --scope`) åœ¨ç›¸åº”çš„ `settings.json` æ–‡ä»¶ä¸­çš„ `mcpServers` å¯¹è±¡ä¸­æŸ¥æ‰¾å¹¶åˆ é™¤ "my-server" æ¡ç›®ã€‚